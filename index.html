<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カロリー＆スケジュール管理アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- マニフェストの指定 -->
  <link rel="manifest" href="manifest.json">
  <!-- Bootstrap CSS / Google Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8f9fa;
      color: #212525;
      transition: background-color 0.3s, color 0.3s;
    }
    /* ダークモード対応 */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #121212;
        color: #e0e0e0;
      }
      .card {
        background-color: #1e1e1e;
      }
    }
    /* 水分進捗バー（残り量が減るデザイン） */
    .progress-container {
      background-color: #28a745;
      height: 30px;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    .progress-water {
      height: 30px;
      background-color: #dc3545;
      transition: width 0.3s;
    }
    .progress-container span {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 30px;
      color: #fff;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="text-center mb-4">カロリー＆スケジュール管理アプリ</h1>
    
    <!-- ダッシュボード -->
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-body text-center">
            <h3>残りカロリー</h3>
            <p id="remaining-calories" class="display-4">-- kcal</p>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-body">
            <h3 class="text-center">水分摂取（残り）</h3>
            <div class="progress-container">
              <div class="progress-water" id="water-progress" style="width: 100%;"></div>
              <span id="water-remaining-text">2000 ml</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 入力フォーム群 -->
    <div class="row">
      <!-- 目標カロリー設定 -->
      <div class="col-md-4 mb-4">
        <div class="card">
          <div class="card-header">目標カロリー設定</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="target-calories" class="form-label">1日の目標カロリー (kcal)</label>
              <input type="number" id="target-calories" class="form-control" placeholder="例: 2000">
            </div>
            <button id="set-target-calories-btn" class="btn btn-primary w-100">設定</button>
          </div>
        </div>
      </div>
      <!-- 食事記録 -->
      <div class="col-md-4 mb-4">
        <div class="card">
          <div class="card-header">食事記録</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="food-name" class="form-label">食品名 (任意)</label>
              <input type="text" id="food-name" class="form-control" placeholder="例: チキンサラダ">
            </div>
            <div class="mb-3">
              <label for="food-calories" class="form-label">カロリー (必須)</label>
              <input type="number" id="food-calories" class="form-control" placeholder="例: 350">
            </div>
            <div class="mb-3">
              <label for="protein" class="form-label">タンパク質 (g)</label>
              <input type="number" id="protein" class="form-control" placeholder="例: 25">
            </div>
            <div class="mb-3">
              <label for="fat" class="form-label">脂質 (g)</label>
              <input type="number" id="fat" class="form-control" placeholder="例: 10">
            </div>
            <div class="mb-3">
              <label for="carbs" class="form-label">炭水化物 (g)</label>
              <input type="number" id="carbs" class="form-control" placeholder="例: 40">
            </div>
            <button id="add-food-btn" class="btn btn-success w-100">フードを追加</button>
          </div>
        </div>
      </div>
      <!-- 水分記録 -->
      <div class="col-md-4 mb-4">
        <div class="card">
          <div class="card-header">水分記録</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="water-amount" class="form-label">摂取した水の量 (ml)</label>
              <input type="number" id="water-amount" class="form-control" placeholder="例: 250">
            </div>
            <button id="add-water-btn" class="btn btn-info w-100">水分を追加</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- スケジュール -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">スケジュール</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label for="schedule-title" class="form-label">タイトル</label>
                <input type="text" id="schedule-title" class="form-control" placeholder="例: ミーティング">
              </div>
              <div class="col-md-4">
                <label for="schedule-date" class="form-label">日付</label>
                <input type="date" id="schedule-date" class="form-control">
              </div>
              <div class="col-md-4">
                <label for="schedule-time" class="form-label">時間</label>
                <input type="time" id="schedule-time" class="form-control">
              </div>
            </div>
            <div class="mt-3">
              <label for="schedule-desc" class="form-label">詳細 (任意)</label>
              <textarea id="schedule-desc" class="form-control" rows="2" placeholder="例: プロジェクト進捗会議"></textarea>
            </div>
            <button id="add-schedule-btn" class="btn btn-secondary w-100 mt-3">スケジュールを追加</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 履歴＆チャート -->
    <div class="row">
      <!-- 履歴 -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">履歴</div>
          <div class="card-body">
            <ul id="history-list" class="list-group">
              <!-- 各種履歴がここに表示されます -->
            </ul>
          </div>
        </div>
      </div>
      <!-- 栄養バランスチャート -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">栄養バランスチャート</div>
          <div class="card-body">
            <canvas id="macroChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- サービスワーカーの登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
      .then(function(registration) {
        console.log('Service Worker 登録完了: ', registration.scope);
      })
      .catch(function(error) {
        console.log('Service Worker 登録失敗: ', error);
      });
    }
  </script>
  
  <!-- 外部ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  
  <!-- メイン JavaScript: 入力処理、保存、更新 -->
  <script>
    // 定数＆初期設定（localStorage 利用）
    const TARGET_CALORIES_KEY    = 'targetCalories';
    const REMAINING_CALORIES_KEY = 'remainingCalories';
    const FOOD_HISTORY_KEY       = 'foodHistory';
    const WATER_HISTORY_KEY      = 'waterHistory';
    const SCHEDULE_HISTORY_KEY   = 'scheduleHistory';
    const TOTAL_WATER_KEY        = 'totalWater';
    const DAILY_WATER_GOAL       = 2000; // ml

    let targetCalories    = parseInt(localStorage.getItem(TARGET_CALORIES_KEY)) || 2000;
    let remainingCalories = parseInt(localStorage.getItem(REMAINING_CALORIES_KEY)) || targetCalories;
    let foodHistory       = JSON.parse(localStorage.getItem(FOOD_HISTORY_KEY)) || [];
    let waterHistory      = JSON.parse(localStorage.getItem(WATER_HISTORY_KEY)) || [];
    let scheduleHistory   = JSON.parse(localStorage.getItem(SCHEDULE_HISTORY_KEY)) || [];
    let totalWater        = parseInt(localStorage.getItem(TOTAL_WATER_KEY)) || 0;

    // ダッシュボード＆水分進捗バー更新
    function updateDashboard() {
      $('#remaining-calories').text(remainingCalories + ' kcal');
      let waterRemaining = DAILY_WATER_GOAL - totalWater;
      if(waterRemaining < 0) waterRemaining = 0;
      $('#water-remaining-text').text(waterRemaining + ' ml');
      let percentage = (waterRemaining / DAILY_WATER_GOAL) * 100;
      $('#water-progress').css('width', percentage + '%');
    }

    // 各種データを localStorage に保存
    function saveData() {
      localStorage.setItem(TARGET_CALORIES_KEY, targetCalories);
      localStorage.setItem(REMAINING_CALORIES_KEY, remainingCalories);
      localStorage.setItem(FOOD_HISTORY_KEY, JSON.stringify(foodHistory));
      localStorage.setItem(WATER_HISTORY_KEY, JSON.stringify(waterHistory));
      localStorage.setItem(SCHEDULE_HISTORY_KEY, JSON.stringify(scheduleHistory));
      localStorage.setItem(TOTAL_WATER_KEY, totalWater);
    }

    // 履歴リストのレンダリング（食事・水分・スケジュール）
    function renderHistory() {
      const $list = $('#history-list');
      $list.empty();
      // 食事履歴
      foodHistory.forEach(entry => {
        const time = moment(entry.timestamp).format('YYYY-MM-DD HH:mm');
        const li = `<li class="list-group-item">[食事] ${entry.foodName || '食品'} - ${entry.calories} kcal, P:${entry.protein}g, F:${entry.fat}g, C:${entry.carbs}g (${time})</li>`;
        $list.append(li);
      });
      // 水分履歴
      waterHistory.forEach(entry => {
        const time = moment(entry.timestamp).format('YYYY-MM-DD HH:mm');
        const li = `<li class="list-group-item">[水分] ${entry.amount} ml (${time})</li>`;
        $list.append(li);
      });
      // スケジュール履歴
      scheduleHistory.forEach(entry => {
        const time = moment(entry.datetime).format('YYYY-MM-DD HH:mm');
        const li = `<li class="list-group-item">[予定] ${entry.title} - ${time} ${entry.desc ? '- ' + entry.desc : ''}</li>`;
        $list.append(li);
      });
    }

    // Chart.js: 栄養バランスチャート更新
    let macroChart;
    function updateChart() {
      let totalProtein = 0, totalFat = 0, totalCarbs = 0;
      foodHistory.forEach(entry => {
        totalProtein += parseFloat(entry.protein) || 0;
        totalFat     += parseFloat(entry.fat) || 0;
        totalCarbs   += parseFloat(entry.carbs) || 0;
      });
      const data = {
        labels: ['タンパク質', '脂質', '炭水化物'],
        datasets: [{
          data: [totalProtein, totalFat, totalCarbs],
          backgroundColor: ['#007bff', '#dc3545', '#ffc107']
        }]
      };
      if(macroChart) {
        macroChart.data = data;
        macroChart.update();
      } else {
        const ctx = document.getElementById('macroChart').getContext('2d');
        macroChart = new Chart(ctx, {
          type: 'pie',
          data: data,
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });
      }
    }

    // 初期表示時に各 UI を更新（保存済みデータの読み込み）
    $(document).ready(function(){
      updateDashboard();
      renderHistory();
      updateChart();
    });

    // イベント：目標カロリー設定
    $('#set-target-calories-btn').click(function(){
      const val = parseInt($('#target-calories').val());
      if(val > 0){
        targetCalories    = val;
        remainingCalories = val;
        saveData();
        updateDashboard();
        alert('目標カロリーを設定しました！');
      } else {
        alert('正しいカロリー値を入力してください');
      }
    });

    // イベント：食事記録追加
    $('#add-food-btn').click(function(){
      const foodName = $('#food-name').val();
      const calories = parseInt($('#food-calories').val());
      const protein  = parseFloat($('#protein').val()) || 0;
      const fat      = parseFloat($('#fat').val()) || 0;
      const carbs    = parseFloat($('#carbs').val()) || 0;
      if(isNaN(calories) || calories <= 0){
        alert('正しいカロリー値を入力してください');
        return;
      }
      const entry = {
        foodName,
        calories,
        protein,
        fat,
        carbs,
        timestamp: new Date().toISOString()
      };
      foodHistory.push(entry);
      remainingCalories = Math.max(remainingCalories - calories, 0);
      saveData();
      updateDashboard();
      renderHistory();
      updateChart();
      $('#food-name, #food-calories, #protein, #fat, #carbs').val('');
    });

    // イベント：水分記録追加
    $('#add-water-btn').click(function(){
      const amount = parseInt($('#water-amount').val());
      if(isNaN(amount) || amount <= 0){
        alert('正しい水の量を入力してください');
        return;
      }
      const entry = { amount, timestamp: new Date().toISOString() };
      waterHistory.push(entry);
      totalWater += amount;
      saveData();
      updateDashboard();
      renderHistory();
      $('#water-amount').val('');
    });

    // イベント：スケジュール追加
    $('#add-schedule-btn').click(function(){
      const title = $('#schedule-title').val();
      const date  = $('#schedule-date').val();
      const time  = $('#schedule-time').val();
      const desc  = $('#schedule-desc').val();
      if(!title || !date || !time){
        alert('タイトル、日付、時間は必須です');
        return;
      }
      const datetime = new Date(date + 'T' + time);
      const entry = { title, datetime: datetime.toISOString(), desc };
      scheduleHistory.push(entry);
      saveData();
      renderHistory();
      $('#schedule-title, #schedule-date, #schedule-time, #schedule-desc').val('');
    });
  </script>
</body>
</html>