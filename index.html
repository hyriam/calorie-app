<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カロリー管理アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- マニフェストの指定（必要なら用意してください） -->
  <link rel="manifest" href="manifest.json">
  <!-- Bootstrap CSS / Google Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8f9fa;
      color: #212529;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-align: center;
    }
    /* カードの見た目をアプリライクに */
    .card {
      margin-bottom: 20px;
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .card-header {
      background-color: #007bff;
      color: #fff;
      font-weight: bold;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      font-size: 1.1rem;
    }
    .card-body {
      background-color: #fff;
      padding: 20px;
      font-size: 1rem;
    }
    /* ダッシュボード用のスタイル */
    .dashboard-card {
      text-align: center;
      padding: 20px;
    }
    .dashboard-card .display-4 {
      font-size: 2.5rem;
      font-weight: bold;
    }
    /* 水分進捗バー（残量が減るデザイン） */
    .progress-container {
      background-color: #28a745;
      height: 30px;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
      margin-top: 10px;
    }
    .progress-water {
      height: 30px;
      background-color: #dc3545;
      transition: width 0.3s;
    }
    .progress-container span {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 30px;
      color: #fff;
      font-weight: bold;
    }
    /* 履歴リストのスタイル */
    .history-list-item {
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>カロリー管理アプリ</h1>
    
    <!-- ダッシュボード -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="card dashboard-card">
          <div class="card-body">
            <h3>残りカロリー</h3>
            <p id="remaining-calories" class="display-4">-- kcal</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card dashboard-card">
          <div class="card-body">
            <h3>水分摂取（残り）</h3>
            <div class="progress-container">
              <div class="progress-water" id="water-progress" style="width: 100%;"></div>
              <span id="water-remaining-text">2000 ml</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 入力フォーム群 -->
    <div class="row">
      <!-- 目標カロリー設定 -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">目標カロリー設定</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="target-calories" class="form-label">1日の目標カロリー (kcal)</label>
              <input type="number" id="target-calories" class="form-control" placeholder="例: 2000">
            </div>
            <button id="set-target-calories-btn" class="btn btn-primary w-100">設定</button>
          </div>
        </div>
      </div>
      <!-- 食事記録 -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">食事記録</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="food-name" class="form-label">食品名 (任意)</label>
              <input type="text" id="food-name" class="form-control" placeholder="例: チキンサラダ">
            </div>
            <div class="mb-3">
              <label for="food-calories" class="form-label">カロリー (必須)</label>
              <input type="number" id="food-calories" class="form-control" placeholder="例: 350">
            </div>
            <div class="mb-3">
              <label for="protein" class="form-label">タンパク質 (g)</label>
              <input type="number" id="protein" class="form-control" placeholder="例: 25">
            </div>
            <div class="mb-3">
              <label for="fat" class="form-label">脂質 (g)</label>
              <input type="number" id="fat" class="form-control" placeholder="例: 10">
            </div>
            <div class="mb-3">
              <label for="carbs" class="form-label">炭水化物 (g)</label>
              <input type="number" id="carbs" class="form-control" placeholder="例: 40">
            </div>
            <button id="add-food-btn" class="btn btn-success w-100">食事を追加</button>
          </div>
        </div>
      </div>
      <!-- 水分記録 -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">水分記録</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="water-amount" class="form-label">摂取した水の量 (ml)</label>
              <input type="number" id="water-amount" class="form-control" placeholder="例: 250">
            </div>
            <button id="add-water-btn" class="btn btn-info w-100">水分を追加</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 履歴（全ての記録を日付付きで表示） -->
    <div class="card">
      <div class="card-header">履歴</div>
      <div class="card-body">
        <ul id="history-list" class="list-group">
          <!-- ここに履歴が追加されます -->
        </ul>
      </div>
    </div>
  </div>
  
  <!-- サービスワーカーの登録（PWA 用） -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
      .then(function(registration) {
        console.log('Service Worker 登録完了: ', registration.scope);
      })
      .catch(function(error) {
        console.log('Service Worker 登録失敗: ', error);
      });
    }
  </script>
  
  <!-- 外部ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  
  <!-- メイン JavaScript -->
  <script>
    /*************************************
     * 定数・初期設定（localStorage利用）
     *************************************/
    const TARGET_CALORIES_KEY = 'targetCalories';
    const FOOD_HISTORY_KEY    = 'foodHistory';
    const WATER_HISTORY_KEY   = 'waterHistory';
    const DAILY_WATER_GOAL    = 2000; // ml

    // targetCalories はユーザー設定値。初期値は localStorage から取得（なければ 2000）
    let targetCalories = parseInt(localStorage.getItem(TARGET_CALORIES_KEY)) || 2000;
    // 履歴は配列として保存（各エントリーは {timestamp, …}）
    let foodHistory  = JSON.parse(localStorage.getItem(FOOD_HISTORY_KEY)) || [];
    let waterHistory = JSON.parse(localStorage.getItem(WATER_HISTORY_KEY)) || [];

    // 今日の日付文字列（YYYY-MM-DD形式）
    function getToday() {
      return moment().format('YYYY-MM-DD');
    }

    // 今日の食事記録を抽出して合計カロリーを計算
    function getTodayFoodCalories() {
      let today = getToday();
      return foodHistory
        .filter(entry => moment(entry.timestamp).format('YYYY-MM-DD') === today)
        .reduce((sum, entry) => sum + entry.calories, 0);
    }

    // 今日の水分記録を抽出して合計水分量を計算
    function getTodayWaterTotal() {
      let today = getToday();
      return waterHistory
        .filter(entry => moment(entry.timestamp).format('YYYY-MM-DD') === today)
        .reduce((sum, entry) => sum + entry.amount, 0);
    }

    // ダッシュボードの更新（今日の記録に基づく）
    function updateDashboard() {
      let todayFood = getTodayFoodCalories();
      let todayWater = getTodayWaterTotal();
      let remainingCalories = Math.max(targetCalories - todayFood, 0);
      $('#remaining-calories').text(remainingCalories + ' kcal');
      
      let waterRemaining = Math.max(DAILY_WATER_GOAL - todayWater, 0);
      $('#water-remaining-text').text(waterRemaining + ' ml');
      let percentage = (waterRemaining / DAILY_WATER_GOAL) * 100;
      $('#water-progress').css('width', percentage + '%');
    }

    // 各種データを localStorage に保存
    function saveData() {
      localStorage.setItem(TARGET_CALORIES_KEY, targetCalories);
      localStorage.setItem(FOOD_HISTORY_KEY, JSON.stringify(foodHistory));
      localStorage.setItem(WATER_HISTORY_KEY, JSON.stringify(waterHistory));
    }

    // 履歴リストのレンダリング（食事・水分の両方をタイムスタンプ順に統合）
    function renderHistory() {
      const $list = $('#history-list');
      $list.empty();
      // 食事記録に type プロパティを追加して統合
      let allLogs = foodHistory.map(entry => ({ 
        type: '食事', 
        timestamp: entry.timestamp, 
        detail: `${entry.foodName || '食品'} - ${entry.calories} kcal (P:${entry.protein}g, F:${entry.fat}g, C:${entry.carbs}g)` 
      }));
      // 水分記録にも type プロパティを追加
      allLogs = allLogs.concat(waterHistory.map(entry => ({ 
        type: '水分', 
        timestamp: entry.timestamp, 
        detail: `${entry.amount} ml`
      })));
      // タイムスタンプで降順にソート
      allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // 各ログをリストアイテムとして追加
      allLogs.forEach(log => {
        let timeStr = moment(log.timestamp).format('YYYY-MM-DD HH:mm');
        let li = `<li class="list-group-item history-list-item">[${log.type}] ${log.detail} (${timeStr})</li>`;
        $list.append(li);
      });
    }

    // Chart.js: 今日の栄養バランスチャート更新（任意で実装可）
    let macroChart;
    function updateChart() {
      // 今日の食事記録のみを対象
      let todayEntries = foodHistory.filter(entry => moment(entry.timestamp).format('YYYY-MM-DD') === getToday());
      let totalProtein = todayEntries.reduce((sum, entry) => sum + (parseFloat(entry.protein) || 0), 0);
      let totalFat     = todayEntries.reduce((sum, entry) => sum + (parseFloat(entry.fat) || 0), 0);
      let totalCarbs   = todayEntries.reduce((sum, entry) => sum + (parseFloat(entry.carbs) || 0), 0);
      
      const data = {
        labels: ['タンパク質', '脂質', '炭水化物'],
        datasets: [{
          data: [totalProtein, totalFat, totalCarbs],
          backgroundColor: ['#007bff', '#dc3545', '#ffc107']
        }]
      };
      if(macroChart) {
        macroChart.data = data;
        macroChart.update();
      } else {
        // ※ チャートを表示する場合は、HTMLに <canvas id="macroChart"></canvas> を配置してください
        const ctx = document.getElementById('macroChart')?.getContext('2d');
        if(ctx) {
          macroChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        }
      }
    }

    // 初期表示時の更新処理
    $(document).ready(function(){
      updateDashboard();
      renderHistory();
      updateChart();
    });

    // イベントリスナー：目標カロリー設定
    $('#set-target-calories-btn').click(function(){
      const val = parseInt($('#target-calories').val());
      if(val > 0) {
        targetCalories = val;
        saveData();
        updateDashboard();
        alert('目標カロリーを設定しました！');
      } else {
        alert('正しいカロリー値を入力してください');
      }
    });

    // イベントリスナー：食事記録追加
    $('#add-food-btn').click(function(){
      const foodName = $('#food-name').val();
      const calories = parseInt($('#food-calories').val());
      const protein  = parseFloat($('#protein').val()) || 0;
      const fat      = parseFloat($('#fat').val()) || 0;
      const carbs    = parseFloat($('#carbs').val()) || 0;
      if(isNaN(calories) || calories <= 0) {
        alert('正しいカロリー値を入力してください');
        return;
      }
      const entry = {
        foodName,
        calories,
        protein,
        fat,
        carbs,
        timestamp: new Date().toISOString()
      };
      foodHistory.push(entry);
      saveData();
      updateDashboard();
      renderHistory();
      updateChart();
      // 入力欄をクリア
      $('#food-name, #food-calories, #protein, #fat, #carbs').val('');
    });

    // イベントリスナー：水分記録追加
    $('#add-water-btn').click(function(){
      const amount = parseInt($('#water-amount').val());
      if(isNaN(amount) || amount <= 0) {
        alert('正しい水の量を入力してください');
        return;
      }
      const entry = { amount, timestamp: new Date().toISOString() };
      waterHistory.push(entry);
      saveData();
      updateDashboard();
      renderHistory();
      $('#water-amount').val('');
    });
  </script>
</body>
</html>
