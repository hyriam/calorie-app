<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カロリー管理アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap, FontAwesome, Chart.js, jQuery（すべてCDN経由） -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* 全体のスタイル（ダークモードベース） */
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #1E1E1E;
      color: #FFFFFF;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .container {
      max-width: 800px;
      padding: 20px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
    }
    /* スライダーコンテナ */
    .slider-container {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      transition: all 0.5s ease;
    }
    .slide {
      min-width: 100%;
      scroll-snap-align: start;
      padding: 10px;
    }
    /* カード */
    .card {
      background-color: #2A2A2A;
      border-radius: 15px;
      border: none;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card-header {
      font-size: 1.2rem;
      font-weight: bold;
      border-bottom: 1px solid #444;
      margin-bottom: 10px;
    }
    .dashboard-card {
      text-align: center;
      padding: 20px;
    }
    .dashboard-card .display-4 {
      font-size: 2.5rem;
      font-weight: bold;
    }
    /* チャートコンテナ */
    .circle-chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    /* 水分進捗バー */
    .water-progress-bar {
      background-color: #007bff;
      border-radius: 5px;
      overflow: hidden;
      height: 25px;
      margin-top: 10px;
    }
    .water-progress {
      background-color: #28a745;
      height: 100%;
      width: 0%;
      transition: width 0.3s;
    }
    /* 下部ナビゲーション */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #2A2A2A;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 100;
    }
    .bottom-nav a {
      color: #FFFFFF;
      font-size: 16px;
      text-align: center;
      text-decoration: none;
    }
    .bottom-nav a i {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }
    /* フローティング＋ボタン */
    .floating-button {
      width: 70px;
      height: 70px;
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #007bff;
      color: white;
      font-size: 30px;
      border: none;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease-in-out;
      z-index: 1000;
    }
    .floating-button:active {
      transform: translateX(-50%) scale(0.9);
    }
  </style>
</head>
<body>
  <!-- スライダーコンテナ：Slide1＝ダッシュボード、Slide2＝栄養素/水分管理、Slide3＝履歴＆ダイアリー -->
  <div class="slider-container" id="sliderContainer">
    <!-- Slide 1: ダッシュボード（カロリー＋水分進捗＋目標設定） -->
    <div class="slide" id="dashboardSlide">
      <div class="container">
        <h1>カロリー管理</h1>
        <!-- カロリーダッシュボード -->
        <div class="card dashboard-card">
          <div class="circle-chart-container">
            <canvas id="calorieChart"></canvas>
          </div>
          <h3>残りカロリー</h3>
          <p id="remaining-calories" class="display-4 text-center">-- kcal</p>
          <!-- カロリー目標設定ボタン -->
          <button class="btn btn-secondary mt-3" id="setTargetBtn">目標設定</button>
        </div>
        <!-- 水分管理 -->
        <div class="card dashboard-card">
          <h3>水分管理</h3>
          <p class="text-center" id="water-status">0 / 2000 ml</p>
          <div class="water-progress-bar">
            <div class="water-progress" id="waterProgress"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 2: 主要栄養素の詳細 -->
    <div class="slide" id="nutrientSlide">
      <div class="container">
        <h1>主要栄養素</h1>
        <div class="row">
          <!-- 炭水化物 -->
          <div class="col-4">
            <div class="card dashboard-card">
              <div class="circle-chart-container">
                <canvas id="carbChart"></canvas>
              </div>
              <h5 class="text-center">炭水化物</h5>
              <p id="carb-grams" class="text-center">0 g</p>
            </div>
          </div>
          <!-- 脂質 -->
          <div class="col-4">
            <div class="card dashboard-card">
              <div class="circle-chart-container">
                <canvas id="fatChart"></canvas>
              </div>
              <h5 class="text-center">脂質</h5>
              <p id="fat-grams" class="text-center">0 g</p>
            </div>
          </div>
          <!-- タンパク質 -->
          <div class="col-4">
            <div class="card dashboard-card">
              <div class="circle-chart-container">
                <canvas id="proteinChart"></canvas>
              </div>
              <h5 class="text-center">タンパク質</h5>
              <p id="protein-grams" class="text-center">0 g</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 3: 履歴＆ダイアリー -->
    <div class="slide" id="historySlide">
      <div class="container">
        <h1>記録履歴</h1>
        <div class="card">
          <div class="card-header">食事・水分履歴</div>
          <ul class="list-group" id="historyList">
            <!-- 履歴リストがここに挿入 -->
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- フローティング＋ボタン（操作モーダルを表示） -->
  <button class="floating-button" id="openActionModal">+</button>

  <!-- 下部ナビゲーション -->
  <div class="bottom-nav">
    <a href="#" data-slide="0"><i class="fas fa-th-large"></i>ダッシュボード</a>
    <a href="#" data-slide="1"><i class="fas fa-apple-alt"></i>栄養素</a>
    <a href="#" data-slide="2"><i class="fas fa-book"></i>履歴</a>
  </div>

  <!-- 【モーダル】操作選択モーダル（食事追加、水分追加） -->
  <div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">記録を追加</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body d-grid gap-3">
          <button class="btn btn-success" id="openMealModal">食事追加</button>
          <button class="btn btn-info" id="openWaterModal">水分追加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 【モーダル】食事追加モーダル -->
  <div class="modal fade" id="mealModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">食事記録を追加</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <form id="mealForm">
            <div class="mb-3">
              <label for="mealName" class="form-label">食品名 (任意)</label>
              <input type="text" class="form-control" id="mealName" placeholder="例: チキンサラダ">
            </div>
            <div class="mb-3">
              <label for="mealCalories" class="form-label">カロリー (必須)</label>
              <input type="number" class="form-control" id="mealCalories" placeholder="例: 350" required>
            </div>
            <div class="mb-3">
              <label for="mealProtein" class="form-label">タンパク質 (g)</label>
              <input type="number" class="form-control" id="mealProtein" placeholder="例: 25">
            </div>
            <div class="mb-3">
              <label for="mealFat" class="form-label">脂質 (g)</label>
              <input type="number" class="form-control" id="mealFat" placeholder="例: 10">
            </div>
            <div class="mb-3">
              <label for="mealCarbs" class="form-label">炭水化物 (g)</label>
              <input type="number" class="form-control" id="mealCarbs" placeholder="例: 40">
            </div>
            <button type="submit" class="btn btn-success w-100">記録を追加</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 【モーダル】水分追加モーダル -->
  <div class="modal fade" id="waterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">水分記録を追加</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <div class="d-grid gap-3">
            <button class="btn btn-info waterPreset" data-amount="250">250 ml</button>
            <button class="btn btn-info waterPreset" data-amount="500">500 ml</button>
            <div class="input-group">
              <input type="number" class="form-control" id="customWater" placeholder="任意の水分量 (ml)">
              <button class="btn btn-info" id="submitCustomWater">追加</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 【モーダル】カロリー目標設定モーダル -->
  <div class="modal fade" id="targetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">カロリー目標を設定</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <form id="targetForm">
            <div class="mb-3">
              <label for="calorieTarget" class="form-label">目標カロリー (kcal)</label>
              <input type="number" class="form-control" id="calorieTarget" placeholder="例: 2500" required>
            </div>
            <button type="submit" class="btn btn-secondary w-100">目標を設定</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 下部ナビゲーション（※リンクにdata-slide属性を付与し、スライダー移動を制御） -->
  <div class="bottom-nav">
    <a href="#" data-slide="0"><i class="fas fa-th-large"></i>ダッシュボード</a>
    <a href="#" data-slide="1"><i class="fas fa-apple-alt"></i>栄養素</a>
    <a href="#" data-slide="2"><i class="fas fa-book"></i>履歴</a>
    <a href="#" id="openTargetModal"><i class="fas fa-cog"></i>設定</a>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Chart.js プラグイン：中央テキスト描画 -->
  <script>
    Chart.register({
      id: 'centerText',
      afterDraw: function(chart) {
        if (chart.config.options.centerText) {
          var ctx = chart.ctx;
          var centerConfig = chart.config.options.centerText;
          var fontStyle = centerConfig.fontStyle || 'Arial';
          var txt = centerConfig.text;
          var color = centerConfig.color || '#fff';
          var maxFontSize = centerConfig.maxFontSize || 75;
          var sidePadding = centerConfig.sidePadding || 20;
          var sidePaddingCalculated = (sidePadding / 100) * (chart.innerRadius * 2);
          ctx.font = "30px " + fontStyle;
          var stringWidth = ctx.measureText(txt).width;
          var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;
          var widthRatio = elementWidth / stringWidth;
          var newFontSize = Math.min(Math.floor(30 * widthRatio), maxFontSize);
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
          var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
          ctx.font = newFontSize + "px " + fontStyle;
          ctx.fillStyle = color;
          ctx.fillText(txt, centerX, centerY);
        }
      }
    });
  </script>

  <!-- メイン JavaScript -->
  <script>
    $(document).ready(function(){

      /**********************************
       * データ初期化と日付リセット処理
       **********************************/
      const today = moment().format('YYYY-MM-DD');
      // localStorageに保存されている日付と比較し、違う場合はリセット
      if(localStorage.getItem('recordDate') !== today) {
        localStorage.removeItem('mealRecords');
        localStorage.removeItem('waterRecords');
        localStorage.setItem('recordDate', today);
      }
      // 初期データ取得
      let mealRecords = JSON.parse(localStorage.getItem('mealRecords')) || [];
      let waterRecords = JSON.parse(localStorage.getItem('waterRecords')) || [];
      let calorieTarget = parseInt(localStorage.getItem('calorieTarget')) || 2500;
      let totalCalories = mealRecords.reduce((sum, rec) => sum + rec.calories, 0);
      let totalCarbs = mealRecords.reduce((sum, rec) => sum + rec.carbs, 0);
      let totalFat = mealRecords.reduce((sum, rec) => sum + rec.fat, 0);
      let totalProtein = mealRecords.reduce((sum, rec) => sum + rec.protein, 0);
      let totalWater = waterRecords.reduce((sum, rec) => sum + rec.amount, 0);
      const waterTarget = 2000;

      /**********************************
       * Chart初期化
       **********************************/
      // カロリーチャート
      let calorieCtx = document.getElementById('calorieChart').getContext('2d');
      let calorieChart = new Chart(calorieCtx, {
        type: 'doughnut',
        data: {
          labels: ['消費済み', '残り'],
          datasets: [{
            data: [totalCalories, Math.max(calorieTarget - totalCalories, 0)],
            backgroundColor: ['#FF5733', '#007bff'],
            hoverOffset: 4
          }]
        },
        options: {
          cutout: '80%',
          plugins: {
            legend: { display: false },
            centerText: {
              text: Math.max(calorieTarget - totalCalories, 0) + " kcal",
              color: "#fff",
              fontStyle: "Arial",
              sidePadding: 20,
              maxFontSize: 30
            }
          }
        }
      });

      // 炭水化物チャート
      let carbCtx = document.getElementById('carbChart').getContext('2d');
      let carbChart = new Chart(carbCtx, {
        type: 'doughnut',
        data: {
          labels: ['摂取', '残り'],
          datasets: [{
            data: [totalCarbs, Math.max(300 - totalCarbs, 0)],
            backgroundColor: ['#FFC107', '#007bff'],
            hoverOffset: 4
          }]
        },
        options: {
          cutout: '80%',
          plugins: {
            legend: { display: false },
            centerText: {
              text: totalCarbs + " g",
              color: "#fff",
              fontStyle: "Arial",
              sidePadding: 20,
              maxFontSize: 20
            }
          }
        }
      });

      // 脂質チャート
      let fatCtx = document.getElementById('fatChart').getContext('2d');
      let fatChart = new Chart(fatCtx, {
        type: 'doughnut',
        data: {
          labels: ['摂取', '残り'],
          datasets: [{
            data: [totalFat, Math.max(70 - totalFat, 0)],
            backgroundColor: ['#DC3545', '#007bff'],
            hoverOffset: 4
          }]
        },
        options: {
          cutout: '80%',
          plugins: {
            legend: { display: false },
            centerText: {
              text: totalFat + " g",
              color: "#fff",
              fontStyle: "Arial",
              sidePadding: 20,
              maxFontSize: 20
            }
          }
        }
      });

      // タンパク質チャート
      let proteinCtx = document.getElementById('proteinChart').getContext('2d');
      let proteinChart = new Chart(proteinCtx, {
        type: 'doughnut',
        data: {
          labels: ['摂取', '残り'],
          datasets: [{
            data: [totalProtein, Math.max(100 - totalProtein, 0)],
            backgroundColor: ['#28A745', '#007bff'],
            hoverOffset: 4
          }]
        },
        options: {
          cutout: '80%',
          plugins: {
            legend: { display: false },
            centerText: {
              text: totalProtein + " g",
              color: "#fff",
              fontStyle: "Arial",
              sidePadding: 20,
              maxFontSize: 20
            }
          }
        }
      });

      // 水分進捗の初期化
      function updateWaterBar() {
        let percentage = Math.min((totalWater / waterTarget) * 100, 100);
        $('#water-status').text(totalWater + " / " + waterTarget + " ml");
        $('#waterProgress').css('width', percentage + "%");
      }
      updateWaterBar();

      /**********************************
       * 更新関数（食事・水分追加時）
       **********************************/
      function updateCalorieData(newMeal) {
        mealRecords.push(newMeal);
        totalCalories += newMeal.calories;
        totalCarbs += newMeal.carbs;
        totalFat += newMeal.fat;
        totalProtein += newMeal.protein;
        localStorage.setItem('mealRecords', JSON.stringify(mealRecords));
        // 更新チャート
        calorieChart.data.datasets[0].data = [totalCalories, Math.max(calorieTarget - totalCalories, 0)];
        calorieChart.options.plugins.centerText.text = Math.max(calorieTarget - totalCalories, 0) + " kcal";
        calorieChart.update();
        carbChart.data.datasets[0].data = [totalCarbs, Math.max(300 - totalCarbs, 0)];
        carbChart.options.plugins.centerText.text = totalCarbs + " g";
        carbChart.update();
        fatChart.data.datasets[0].data = [totalFat, Math.max(70 - totalFat, 0)];
        fatChart.options.plugins.centerText.text = totalFat + " g";
        fatChart.update();
        proteinChart.data.datasets[0].data = [totalProtein, Math.max(100 - totalProtein, 0)];
        proteinChart.options.plugins.centerText.text = totalProtein + " g";
        proteinChart.update();
        renderHistory();
      }

      function updateWaterData(amount) {
        waterRecords.push({ amount: amount, timestamp: new Date().toISOString() });
        totalWater += amount;
        localStorage.setItem('waterRecords', JSON.stringify(waterRecords));
        updateWaterBar();
        renderHistory();
      }

      /**********************************
       * 履歴レンダリング
       **********************************/
      function renderHistory() {
        const $list = $('#historyList');
        $list.empty();
        let allRecords = [];
        // 食事記録
        mealRecords.forEach((rec, idx) => {
          allRecords.push({
            type: '食事',
            detail: rec.mealName ? rec.mealName : '食品',
            calories: rec.calories,
            protein: rec.protein,
            fat: rec.fat,
            carbs: rec.carbs,
            timestamp: rec.timestamp,
            index: idx,
            recordType: 'meal'
          });
        });
        // 水分記録
        waterRecords.forEach((rec, idx) => {
          allRecords.push({
            type: '水分',
            detail: rec.amount + " ml",
            timestamp: rec.timestamp,
            index: idx,
            recordType: 'water'
          });
        });
        // 降順にソート
        allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        allRecords.forEach(rec => {
          let timeStr = moment(rec.timestamp).format('YYYY-MM-DD HH:mm');
          let li = `<li class="list-group-item bg-dark text-white" data-type="${rec.recordType}" data-index="${rec.index}" style="cursor:pointer;">
                      [${rec.type}] ${rec.detail} (${timeStr})
                    </li>`;
          $list.append(li);
        });
      }
      renderHistory();

      /**********************************
       * モーダル操作＆イベント
       **********************************/
      // フローティングボタンから操作モーダルを表示
      $('#openActionModal').click(function(){
        new bootstrap.Modal(document.getElementById('actionModal')).show();
      });
      // 食事追加モーダル表示
      $('#openMealModal').click(function(){
        bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        new bootstrap.Modal(document.getElementById('mealModal')).show();
      });
      // 水分追加モーダル表示
      $('#openWaterModal').click(function(){
        bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        new bootstrap.Modal(document.getElementById('waterModal')).show();
      });
      // カロリー目標設定モーダル表示
      $('#openTargetModal').click(function(){
        new bootstrap.Modal(document.getElementById('targetModal')).show();
      });
      // 食事フォーム送信
      $('#mealForm').submit(function(e){
        e.preventDefault();
        let newMeal = {
          mealName: $('#mealName').val(),
          calories: parseInt($('#mealCalories').val()),
          protein: parseInt($('#mealProtein').val()) || 0,
          fat: parseInt($('#mealFat').val()) || 0,
          carbs: parseInt($('#mealCarbs').val()) || 0,
          timestamp: new Date().toISOString()
        };
        updateCalorieData(newMeal);
        bootstrap.Modal.getInstance(document.getElementById('mealModal')).hide();
        alert("食事記録を追加しました！");
      });
      // 水分プリセットボタン
      $('.waterPreset').click(function(){
        let amt = parseInt($(this).attr('data-amount'));
        updateWaterData(amt);
        bootstrap.Modal.getInstance(document.getElementById('waterModal')).hide();
        alert("水分 " + amt + " ml を追加しました！");
      });
      // カスタム水分追加
      $('#submitCustomWater').click(function(){
        let amt = parseInt($('#customWater').val());
        if(isNaN(amt) || amt <= 0) {
          alert("正しい水分量を入力してください");
          return;
        }
        updateWaterData(amt);
        bootstrap.Modal.getInstance(document.getElementById('waterModal')).hide();
        alert("水分 " + amt + " ml を追加しました！");
      });
      // カロリー目標設定フォーム送信
      $('#targetForm').submit(function(e){
        e.preventDefault();
        calorieTarget = parseInt($('#calorieTarget').val());
        localStorage.setItem('calorieTarget', calorieTarget);
        // 更新
        calorieChart.data.datasets[0].data = [totalCalories, Math.max(calorieTarget - totalCalories, 0)];
        calorieChart.options.plugins.centerText.text = Math.max(calorieTarget - totalCalories, 0) + " kcal";
        calorieChart.update();
        bootstrap.Modal.getInstance(document.getElementById('targetModal')).hide();
        alert("カロリー目標を " + calorieTarget + " kcal に設定しました！");
      });

      /**********************************
       * 下部ナビゲーション操作（スライダー移動）
       **********************************/
      $('.bottom-nav a').click(function(e){
        e.preventDefault();
        let slideIndex = $(this).attr('data-slide');
        let slideWidth = $('.slide').outerWidth();
        $('#sliderContainer').animate({ scrollLeft: slideIndex * slideWidth }, 300);
      });

      /**********************************
       * 履歴項目クリックで編集（簡易実装例：食事のみ）
       **********************************/
      $('#historyList').on('click', 'li', function(){
        let type = $(this).attr('data-type');
        let index = $(this).attr('data-index');
        if(type === 'meal') {
          // 編集用に食事記録フォームに値をセット
          let rec = mealRecords[index];
          $('#mealName').val(rec.mealName);
          $('#mealCalories').val(rec.calories);
          $('#mealProtein').val(rec.protein);
          $('#mealFat').val(rec.fat);
          $('#mealCarbs').val(rec.carbs);
          // 一旦該当記録を削除しておく（再登録時に上書き）
          mealRecords.splice(index, 1);
          localStorage.setItem('mealRecords', JSON.stringify(mealRecords));
          // 更新（再計算は省略：本サンプルでは新規追加として扱う）
          new bootstrap.Modal(document.getElementById('mealModal')).show();
        } else {
          alert("水分記録の編集は未実装です。");
        }
      });

    });
  </script>
</body>
</html>
